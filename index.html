<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Controle de Estoque</title>
<meta name="theme-color" content="#1f2937">

<!-- Firebase v10 -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
  :root{
    --bg:#1f2937;--card:#374151;--fg:#f9fafb;
    --temos:#10b981;--acabando:#ef4444;--muted:#9ca3af;
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:system-ui,-apple-system,sans-serif;
    background:var(--bg);color:var(--fg);
  }
  
  header{
    background:var(--card);padding:16px;text-align:center;
    border-bottom:1px solid #4b5563;
  }
  .title{font-size:1.2rem;font-weight:700;margin-bottom:4px}
  .subtitle{font-size:0.9rem;color:var(--muted)}
  
  .container{max-width:600px;margin:0 auto;padding:16px}
  
  /* Login Card */
  .login-card{
    background:var(--card);border-radius:12px;padding:20px;
    margin:20px auto;max-width:400px;text-align:center;
  }
  .login-input{
    width:100%;padding:12px;border:1px solid #6b7280;
    border-radius:8px;background:#1f2937;color:var(--fg);
    font-size:1rem;margin:12px 0;text-align:center;
    text-transform:uppercase;
  }
  .login-btn{
    width:100%;padding:12px;background:var(--temos);
    border:none;border-radius:8px;color:white;
    font-weight:600;font-size:1rem;cursor:pointer;
  }
  
  .add-section{
    background:var(--card);border-radius:12px;padding:16px;margin-bottom:20px;
  }
  .add-input{
    width:100%;padding:12px;border:1px solid #6b7280;
    border-radius:8px;background:#1f2937;color:var(--fg);
    font-size:1rem;margin-bottom:12px;
  }
  .add-input:focus{outline:none;border-color:var(--temos)}
  .add-btn{
    width:100%;padding:12px;background:var(--temos);
    border:none;border-radius:8px;color:white;
    font-weight:600;font-size:1rem;cursor:pointer;
  }
  
  .connection-status{
    display:flex;align-items:center;justify-content:center;
    gap:8px;margin-bottom:16px;padding:8px;
    border-radius:8px;font-size:0.9rem;
  }
  .status-online{background:#065f46;color:#10b981}
  .status-offline{background:#7f1d1d;color:#ef4444}
  .status-connecting{background:#92400e;color:#f59e0b}
  
  .filter-section{
    display:flex;gap:12px;margin-bottom:20px;
  }
  .filter-btn{
    flex:1;padding:10px;border:2px solid #4b5563;
    border-radius:8px;background:transparent;color:var(--fg);
    cursor:pointer;font-weight:500;
  }
  .filter-btn.active{background:var(--temos);border-color:var(--temos);color:white}
  .filter-btn.acabando-filter.active{background:var(--acabando);border-color:var(--acabando)}
  
  .items-list{display:grid;gap:8px}
  .item{
    background:var(--card);border-radius:12px;padding:16px;
    display:flex;justify-content:space-between;align-items:center;
    cursor:pointer;border:2px solid transparent;
    transition:all 0.2s ease;
  }
  .item:hover{border-color:#6b7280}
  .item.temos{border-left:4px solid var(--temos)}
  .item.acabando{border-left:4px solid var(--acabando)}
  
  .item-name{font-weight:500;font-size:1.1rem}
  .item-status{
    padding:6px 12px;border-radius:20px;font-size:0.85rem;
    font-weight:600;
  }
  .status-temos{background:var(--temos);color:white}
  .status-acabando{background:var(--acabando);color:white}
  
  .delete-btn{
    background:none;border:none;color:#9ca3af;
    cursor:pointer;font-size:1.2rem;margin-left:12px;
  }
  .delete-btn:hover{color:var(--acabando)}
  
  .stats{
    display:flex;gap:16px;margin-bottom:20px;text-align:center;
  }
  .stat{flex:1;background:var(--card);padding:12px;border-radius:8px}
  .stat-num{font-size:1.5rem;font-weight:700;margin-bottom:4px}
  .stat-label{font-size:0.8rem;color:var(--muted)}
  .stat-temos{color:var(--temos)}
  .stat-acabando{color:var(--acabando)}
  
  .empty{text-align:center;padding:40px;color:var(--muted)}
  
  .toast{
    position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
    background:#374151;color:var(--fg);padding:12px 20px;
    border-radius:8px;opacity:0;transition:opacity 0.3s;z-index:1000;
  }
  .toast.show{opacity:1}
  
  .hidden{display:none}
</style>
</head>

<body>
<header>
  <div class="title">üè† Controle de Estoque</div>
  <div class="subtitle">Sincronizado entre dispositivos</div>
</header>

<!-- Login -->
<div id="loginSection" class="hidden">
  <div class="login-card">
    <h3>C√≥digo da Casa</h3>
    <input id="houseCode" class="login-input" placeholder="DIGITE SEU C√ìDIGO" maxlength="20">
    <button id="loginBtn" class="login-btn">Entrar</button>
    <p style="color:var(--muted);font-size:0.9rem;margin-top:16px">
      Use o mesmo c√≥digo em todos os dispositivos da fam√≠lia
    </p>
  </div>
</div>

<!-- App Principal -->
<div id="appSection" class="container hidden">
  
  <div id="connectionStatus" class="connection-status status-connecting">
    <span>üîÑ Conectando...</span>
  </div>
  
  <div class="add-section">
    <input id="newItem" class="add-input" placeholder="Adicionar novo item (ex: Detergente)" maxlength="50">
    <button id="addBtn" class="add-btn">Adicionar Item</button>
  </div>
  
  <div class="stats">
    <div class="stat">
      <div class="stat-num stat-temos" id="temosCount">0</div>
      <div class="stat-label">Temos</div>
    </div>
    <div class="stat">
      <div class="stat-num stat-acabando" id="acabandoCount">0</div>
      <div class="stat-label">Acabando</div>
    </div>
  </div>
  
  <div class="filter-section">
    <button class="filter-btn active" data-filter="all">Todos os Itens</button>
    <button class="filter-btn acabando-filter" data-filter="acabando">Precisa Comprar</button>
  </div>
  
  <div id="itemsList" class="items-list"></div>
  
  <div id="emptyState" class="empty hidden">
    Nenhum item encontrado.<br>
    Adicione itens que voc√™s sempre mant√™m em casa.
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
// Configura√ß√£o Firebase
const firebaseConfig = {
  apiKey: "AIzaSyC5Qx9REGwO6vjTFQBcgFx4lcPi7Hz3LFg",
  authDomain: "lista-mercado-713c5.firebaseapp.com",
  projectId: "lista-mercado-713c5",
  storageBucket: "lista-mercado-713c5.firebasestorage.app",
  messagingSenderId: "728322221496",
  appId: "1:728322221496:web:180e0ec1a6f30ad1d35b4d"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Estado global
let HOUSE_CODE = localStorage.getItem('estoque_house_code') || '';
let items = [];
let currentFilter = 'all';
let unsubscribe = null;

// Items padr√£o
const DEFAULT_ITEMS = [
  'Detergente', 'Sab√£o em p√≥', 'Papel higi√™nico', 'Pasta de dente',
  'Arroz', 'Feij√£o', 'A√ß√∫car', 'Sal', '√ìleo', 'Caf√©',
  'Leite', 'P√£o', 'Ovos', 'Manteiga'
];

// Utilit√°rios
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

function updateConnectionStatus(status) {
  const statusEl = document.getElementById('connectionStatus');
  const statusMap = {
    connecting: { class: 'status-connecting', text: 'üîÑ Conectando...' },
    online: { class: 'status-online', text: 'üü¢ Online e sincronizado' },
    offline: { class: 'status-offline', text: 'üî¥ Offline' }
  };
  
  const config = statusMap[status];
  statusEl.className = `connection-status ${config.class}`;
  statusEl.innerHTML = `<span>${config.text}</span>`;
}

// Autentica√ß√£o
async function loginAnonymously() {
  try {
    await auth.signInAnonymously();
    bindRealtimeData();
    updateConnectionStatus('online');
  } catch (error) {
    console.error('Erro de login:', error);
    updateConnectionStatus('offline');
    showToast('Erro de conex√£o');
  }
}

// Firebase Realtime
function bindRealtimeData() {
  const itemsRef = db.collection('estoque').doc(HOUSE_CODE).collection('items');
  
  if (unsubscribe) unsubscribe();
  
  unsubscribe = itemsRef.onSnapshot(snapshot => {
    items = [];
    snapshot.forEach(doc => {
      items.push({ id: doc.id, ...doc.data() });
    });
    
    // Se n√£o h√° itens, adiciona os padr√£o
    if (items.length === 0) {
      addDefaultItems();
      return;
    }
    
    render();
    updateConnectionStatus('online');
  }, error => {
    console.error('Erro na sincroniza√ß√£o:', error);
    updateConnectionStatus('offline');
  });
}

async function addDefaultItems() {
  const batch = db.batch();
  const itemsRef = db.collection('estoque').doc(HOUSE_CODE).collection('items');
  
  DEFAULT_ITEMS.forEach(name => {
    const docRef = itemsRef.doc();
    batch.set(docRef, {
      name,
      status: 'temos',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  });
  
  try {
    await batch.commit();
    showToast('Itens padr√£o adicionados');
  } catch (error) {
    console.error('Erro ao adicionar itens padr√£o:', error);
  }
}

// CRUD Operations
async function addItem() {
  const input = document.getElementById('newItem');
  const name = input.value.trim();
  
  if (!name) {
    showToast('Digite o nome do item');
    return;
  }
  
  if (items.some(item => item.name.toLowerCase() === name.toLowerCase())) {
    showToast('Item j√° existe na lista');
    return;
  }
  
  try {
    await db.collection('estoque').doc(HOUSE_CODE).collection('items').add({
      name,
      status: 'temos',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    input.value = '';
    showToast(`${name} adicionado`);
  } catch (error) {
    console.error('Erro ao adicionar:', error);
    showToast('Erro ao adicionar item');
  }
}

async function toggleStatus(id) {
  const item = items.find(i => i.id === id);
  if (!item) return;
  
  const newStatus = item.status === 'temos' ? 'acabando' : 'temos';
  
  try {
    await db.collection('estoque').doc(HOUSE_CODE).collection('items').doc(id).update({
      status: newStatus,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    const statusText = newStatus === 'temos' ? 'Temos' : 'Acabando';
    showToast(`${item.name}: ${statusText}`);
  } catch (error) {
    console.error('Erro ao atualizar:', error);
    showToast('Erro ao atualizar item');
  }
}

async function deleteItem(id, event) {
  event.stopPropagation();
  
  const item = items.find(i => i.id === id);
  if (!item) return;
  
  if (!confirm(`Remover "${item.name}" da lista?`)) return;
  
  try {
    await db.collection('estoque').doc(HOUSE_CODE).collection('items').doc(id).delete();
    showToast(`${item.name} removido`);
  } catch (error) {
    console.error('Erro ao deletar:', error);
    showToast('Erro ao remover item');
  }
}

// UI Functions
function setFilter(filter) {
  currentFilter = filter;
  
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.filter === filter);
  });
  
  render();
}

function render() {
  const list = document.getElementById('itemsList');
  const emptyState = document.getElementById('emptyState');
  
  // Filter items
  let filteredItems = items;
  if (currentFilter === 'acabando') {
    filteredItems = items.filter(item => item.status === 'acabando');
  }
  
  // Sort: acabando first, then alphabetical
  filteredItems.sort((a, b) => {
    if (a.status !== b.status) {
      return a.status === 'acabando' ? -1 : 1;
    }
    return a.name.localeCompare(b.name);
  });
  
  // Update stats
  const temosCount = items.filter(i => i.status === 'temos').length;
  const acabandoCount = items.filter(i => i.status === 'acabando').length;
  
  document.getElementById('temosCount').textContent = temosCount;
  document.getElementById('acabandoCount').textContent = acabandoCount;
  
  // Render items
  if (filteredItems.length === 0) {
    list.classList.add('hidden');
    emptyState.classList.remove('hidden');
    return;
  }
  
  list.classList.remove('hidden');
  emptyState.classList.add('hidden');
  
  list.innerHTML = filteredItems.map(item => `
    <div class="item ${item.status}" onclick="toggleStatus('${item.id}')">
      <div class="item-name">${item.name}</div>
      <div style="display: flex; align-items: center;">
        <span class="item-status status-${item.status}">
          ${item.status === 'temos' ? 'Temos' : 'Acabando'}
        </span>
        <button class="delete-btn" onclick="deleteItem('${item.id}', event)">√ó</button>
      </div>
    </div>
  `).join('');
}

// Event Listeners
document.getElementById('loginBtn').onclick = () => {
  const code = document.getElementById('houseCode').value.trim().toUpperCase();
  if (!code) {
    showToast('Digite um c√≥digo v√°lido');
    return;
  }
  
  HOUSE_CODE = code;
  localStorage.setItem('estoque_house_code', HOUSE_CODE);
  
  document.getElementById('loginSection').classList.add('hidden');
  document.getElementById('appSection').classList.remove('hidden');
  
  loginAnonymously();
};

document.getElementById('addBtn').onclick = addItem;
document.getElementById('newItem').addEventListener('keypress', e => {
  if (e.key === 'Enter') addItem();
});

document.getElementById('houseCode').addEventListener('keypress', e => {
  if (e.key === 'Enter') document.getElementById('loginBtn').click();
});

document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.onclick = () => setFilter(btn.dataset.filter);
});

// Monitorar conectividade
window.addEventListener('online', () => updateConnectionStatus('online'));
window.addEventListener('offline', () => updateConnectionStatus('offline'));

// Inicializa√ß√£o
if (HOUSE_CODE) {
  document.getElementById('loginSection').classList.add('hidden');
  document.getElementById('appSection').classList.remove('hidden');
  loginAnonymously();
} else {
  document.getElementById('loginSection').classList.remove('hidden');
}
</script>
</body>
</html>
